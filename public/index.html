<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>HODL Token Club | NFT Rewards Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* GLOBAL RESET */
    * { box-sizing: border-box; }

    /* CORE LAYOUT */
    body { font-family: Arial, sans-serif; margin: 0; padding-bottom: 60px; }
    
    /* INPUTS & BUTTONS */
    label, input, button { font-size: 1em; }
    
    input { 
      padding: 10px; 
      width: 100%;
      max-width: 100%; 
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button.btn { 
      padding: 10px 20px; 
      cursor: pointer; 
      max-width: 100%;
    }

    /* GRID SYSTEM */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: min-content;
      gap: 30px;
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }

    /* MOBILE ADJUSTMENTS */
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
        padding: 0 15px;
        gap: 25px;
      }
      .header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
    }

    /* CARD UTILITIES */
    .glow-card, .glow-panel {
      height: auto !important;
      min-height: 100%;
      width: 100%;
      overflow: hidden;
      padding: 20px;
      border-radius: 12px;
      position: relative;
      background: rgba(0,0,0,0.4);
      top: auto; 
      left: auto;
    }

    /* METRIC CARDS */
    .metric-card {
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 120px;
    }
    
    .metric-title {
      font-size: 0.9em;
      text-transform: uppercase;
      opacity: 0.8;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }
    
    .metric-value {
      font-size: 1.8em;
      font-weight: 700;
      line-height: 1.2;
      /* Allow flex column for rank + count */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* RANK BADGES */
    .rank-badge {
      display: inline-block;
      font-size: 0.6em; /* Adjusted for container scaling */
      padding: 8px 16px;
      border-radius: 20px;
      color: #fff;
      font-weight: 700;
      text-transform: uppercase;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      letter-spacing: 0.5px;
    }

    .rank-mega-whale { background: linear-gradient(135deg, #8e44ad, #f1c40f); border: 1px solid #f1c40f; }
    .rank-whale { background: linear-gradient(135deg, #2c3e50, #34495e); border: 1px solid #7f8c8d; }
    .rank-shark { background: linear-gradient(135deg, #16a085, #1abc9c); border: 1px solid #a3e4d7; }
    .rank-dolphin { background: linear-gradient(135deg, #2980b9, #3498db); border: 1px solid #aed6f1; }
    .rank-crab { background: linear-gradient(135deg, #c0392b, #e74c3c); border: 1px solid #f5b7b1; }
    .rank-fish { background: linear-gradient(135deg, #d35400, #e67e22); border: 1px solid #fad7a0; }
    .rank-plankton { background: linear-gradient(135deg, #27ae60, #2ecc71); border: 1px solid #abebc6; }
    
    .rank-none { color: #aaa; font-size: 1.2em; font-weight: bold; }
  </style>
</head>
<body>

<header class="header">
  <div class="header-left">
    <img src="Hodl_logo.jpg" alt="HODL Logo" class="logo-hodl" />
  </div>
  <div class="header-center">
    <div class="project-title">HODL Token Club</div>
    <div class="project-subtitle">on MultiversX Blockchain</div>
  </div>
  <div class="header-right">
    <img src="mvx-ledger-icon-mint.svg" alt="MultiversX Logo" class="logo-mvx" />
  </div>
</header>

<div class="dashboard-grid">
  
  <div class="glow-card metric-card">
    <div class="metric-title">Minted by now (EMP)</div>
    <div class="metric-value" id="mintedCount">Loading...</div>
  </div>

  <div class="glow-card metric-card">
    <div class="metric-title">Wallet Rank</div>
    <div class="metric-value" id="walletRankDisplay" style="font-size: 1.5em;">—</div>
  </div>

  <div class="glow-card" id="publicCalculator">
    <h1>Calculate Wallet NFT Rewards</h1>
    <form class="input-row" onsubmit="return false;">
      <label for="walletInput" style="display:block; margin-bottom:5px;">Wallet Address</label>
      <input type="text" id="walletInput" placeholder="erd1..." autocomplete="off" />
    </form>
    <button class="btn" id="calculateBtn">Calculate Rewards</button>
  </div>

  <div class="glow-card" id="traitsSection" style="display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 200px;">
    <h1 style="margin-top:0;">Traits Distribution</h1>
    <a href="http://203.161.43.175:3012/stats.html" target="_blank" rel="noopener" class="btn" style="display:block; width:100%; text-align:center;">Open Trait Distribution</a>
  </div>

  <div class="glow-panel">
    <h2>Total Weekly Reward: <span id="totalReward">—</span></h2>
    <div>
      <div style="font-weight:500; margin-bottom:10px;">Category Reward Totals:</div>
      <ul class="category-totals" id="categoryTotals" style="padding-left: 20px; margin-bottom: 20px;"></ul>
    </div>
    <button class="btn" id="showManageBtn">Manage Rewards</button>
  </div>

  <div class="glow-panel" style="min-width: unset;">
    <div class="debug-info" style="margin-bottom:15px;">Detailed Info</div>
    <div id="categoriesContainer"></div>
    <div id="excludedNFTsSection" style="margin-top:20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top:10px;">
      <div style="font-size:1em;font-weight:600; margin-bottom:5px;">NFTs Excluded</div>
      <ul id="excludedNFTsList" style="padding-left: 20px;"></ul>
    </div>
  </div>

</div>

<div id="passwordSection" style="display:none; margin: 20px auto; max-width:900px; padding: 0 10px;">
  <label for="passwordInput" style="font-weight: 700; font-size: 1.03em; color: #AEEFFF; display:block; margin-bottom:5px;">Enter Admin Password:</label>
  <input type="password" id="passwordInput" placeholder="Enter password" autocomplete="off" style="background:#080f12; border:2px solid #10a8c2; color:#AEF7FE;" />
  <div style="margin-top:5px;">
    <button class="btn" id="passwordBtn" style="margin-right: 8px;">Submit</button>
    <button class="btn" id="cancelPasswordBtn" style="background:#ff5555; color:#14161a; box-shadow:none;">Cancel</button>
  </div>
  <div class="error" id="passwordError" style="margin-top: 8px;"></div>
</div>

<div id="rewardsManagement" style="display:none; max-width:900px; margin: 32px auto; padding: 0 10px;">
  <button id="logoutBtn" class="btn" style="float: right; margin-bottom: 12px; background: #ff6666; color: #14161a; box-shadow:none;">Logout</button>
  <h2>Category-based Trait Rewards</h2>

  <h3>Add/Update Reward</h3>
  <form id="addRewardForm" style="display:flex; gap: 10px; flex-wrap: wrap; align-items:center;">
    <div style="flex: 1 1 200px;">
      <label>Category:</label>
      <input type="text" id="newCategory" required autocomplete="off" style="background: #080f12; color:#AEF7FE; border: 2px solid #10a8c2;" />
    </div>
    <div style="flex: 1 1 100px;">
      <label>Reward:</label>
      <input type="number" id="newReward" required min="0" style="background: #080f12; color:#AEF7FE; border: 2px solid #10a8c2;" />
    </div>
    <button type="submit" class="btn" style="flex: 1 1 100%;">Save Reward</button>
  </form>
  <div class="error" id="formError" style="margin-top: 6px; color:#ff6666;"></div>

  <h3 style="margin-top: 28px;">Existing Rewards</h3>
  <div style="overflow-x:auto;">
    <table id="rewardsTable" aria-label="Category rewards table" style="width:100%; border-collapse: collapse; min-width: 300px;">
      <thead>
        <tr style="border-bottom: 1px solid #10a8c2;">
          <th style="text-align:left; padding: 10px;">Category</th>
          <th style="text-align:right; padding: 10px;">Reward</th>
          <th style="text-align:center; padding: 10px;">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h2 style="margin-top: 36px;">Resync Categories</h2>
  <button id="resyncCollectionBtn" class="btn">Resync Categories</button>
</div>

<script>
const empCollectionId = "EMP-897b49";
const fhodlCollectionId = "FHODL-a9ad67";
const fhodlRewardRate = 1400;

const mintedCountSpan = document.getElementById('mintedCount');
const walletRankDisplay = document.getElementById('walletRankDisplay');
const calculateBtn = document.getElementById('calculateBtn');
const walletInput = document.getElementById('walletInput');
const showManageBtn = document.getElementById('showManageBtn');
const passwordSection = document.getElementById('passwordSection');
const passwordInput = document.getElementById('passwordInput');
const passwordBtn = document.getElementById('passwordBtn');
const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
const passwordError = document.getElementById('passwordError');
const rewardsDiv = document.getElementById('rewardsManagement');
const logoutBtn = document.getElementById('logoutBtn');

const totalRewardEl = document.getElementById('totalReward');
const categoryTotalsEl = document.getElementById('categoryTotals');
const categoriesContainer = document.getElementById('categoriesContainer');
const excludedList = document.getElementById('excludedNFTsList');
const rewardsTableBody = document.querySelector('#rewardsTable tbody');
const formError = document.getElementById('formError');
const addRewardForm = document.getElementById('addRewardForm');

showManageBtn.addEventListener('click', () => {
  showManageBtn.style.display = 'none';
  passwordSection.style.display = 'block';
  passwordInput.focus();
});

passwordBtn.addEventListener('click', () => {
  const pw = passwordInput.value.trim();
  if (pw === 'nothing') {
    passwordError.textContent = '';
    passwordSection.style.display = 'none';
    passwordInput.value = '';
    rewardsDiv.style.display = 'block';
    loadConfig();
  } else {
    passwordError.textContent = 'Incorrect password';
  }
});

cancelPasswordBtn.addEventListener('click', () => {
  passwordSection.style.display = 'none';
  passwordError.textContent = '';
  passwordInput.value = '';
  showManageBtn.style.display = 'inline-block';
});

logoutBtn.addEventListener('click', () => {
  rewardsDiv.style.display = 'none';
  passwordSection.style.display = 'none';
  showManageBtn.style.display = 'inline-block';
  totalRewardEl.textContent = '—';
  walletRankDisplay.innerHTML = '—';
  walletRankDisplay.className = 'metric-value';
  categoryTotalsEl.innerHTML = '';
  categoriesContainer.innerHTML = '';
  excludedList.innerHTML = '';
  walletInput.value = '';
});

async function loadConfig() {
  formError.textContent = '';
  const res = await fetch('/api/config');
  const traitRewards = await res.json();
  renderTable(traitRewards);
}

function renderTable(traitRewards) {
  rewardsTableBody.innerHTML = '';
  for (const [category, rewardVal] of Object.entries(traitRewards)) {
    const reward = Number(rewardVal);
    const row = document.createElement('tr');
    row.innerHTML = `
      <td style="padding: 6px 10px;">${category}</td>
      <td style="padding: 6px 10px; text-align: right;">
        <input type="number" value="${isNaN(reward) ? 0 : reward}" min="0" style="width: 70px;" onchange="updateReward('${category}', this.value)">
      </td>
      <td style="padding: 6px 10px; text-align: center;">
        <button onclick="deleteReward('${category}')" style="padding:4px 12px; background:#ff5555; color:#14161a; border:none; border-radius: 6px; cursor:pointer;">Delete</button>
      </td>
    `;
    rewardsTableBody.appendChild(row);
  }
}

async function updateReward(category, reward) {
  reward = parseInt(reward);
  if (isNaN(reward)) return;
  await fetch('/api/config', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ category, reward }),
  });
  await loadConfig();
}

async function deleteReward(category) {
  await fetch('/api/config', {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ category }),
  });
  await loadConfig();
}

addRewardForm.addEventListener('submit', async e => {
  e.preventDefault();
  const category = document.getElementById('newCategory').value.trim();
  const reward = parseInt(document.getElementById('newReward').value);
  if (!category || isNaN(reward) || reward < 0) {
    formError.textContent = 'Fill all fields correctly.';
    return;
  }
  await fetch('/api/config', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ category, reward }),
  });
  e.target.reset();
  await loadConfig();
});

calculateBtn.addEventListener('click', async () => {
  const wallet = walletInput.value.trim();
  totalRewardEl.textContent = '—';
  
  // Reset Rank Display
  walletRankDisplay.innerHTML = 'Loading...';
  
  categoryTotalsEl.innerHTML = '';
  categoriesContainer.innerHTML = '';
  excludedList.innerHTML = '';
  
  if (!wallet) {
    alert('Please enter a wallet address');
    walletRankDisplay.innerHTML = '—';
    return;
  }
  totalRewardEl.textContent = 'Loading...';

  try {
    const empPromise = fetch(`/api/rewards/${wallet}/${empCollectionId}`);
    const fhodlPromise = fetch(`https://api.multiversx.com/accounts/${wallet}/nfts?collection=${fhodlCollectionId}&size=2000`);

    const [empRes, fhodlRes] = await Promise.all([empPromise, fhodlPromise]);
    
    const empData = await empRes.json();
    if (!empRes.ok) throw new Error(empData.error || "Error fetching EMP data");

    const fhodlNFTs = await fhodlRes.json();
    const fhodlCount = Array.isArray(fhodlNFTs) ? fhodlNFTs.length : 0;
    const fhodlTotalReward = fhodlCount * fhodlRewardRate;

    const empTotalReward = parseFloat(empData.totalReward) || 0;
    const grandTotalReward = empTotalReward + fhodlTotalReward;

    totalRewardEl.textContent = grandTotalReward.toLocaleString();

    // --- RANK LOGIC (EMP Only) ---
    const includedCount = empData.includedNFTs ? empData.includedNFTs.length : 0;
    const excludedCount = empData.excludedNFTs ? empData.excludedNFTs.length : 0;
    const totalEmpNFTs = includedCount + excludedCount;
    
    let rankName = 'No Rank';
    let rankClass = 'rank-none';

    if (totalEmpNFTs >= 500) { rankName = 'Mega Whale'; rankClass = 'rank-mega-whale'; }
    else if (totalEmpNFTs >= 250) { rankName = 'Whale'; rankClass = 'rank-whale'; }
    else if (totalEmpNFTs >= 100) { rankName = 'Shark'; rankClass = 'rank-shark'; }
    else if (totalEmpNFTs >= 50) { rankName = 'Dolphin'; rankClass = 'rank-dolphin'; }
    else if (totalEmpNFTs >= 25) { rankName = 'Crab'; rankClass = 'rank-crab'; }
    else if (totalEmpNFTs >= 10) { rankName = 'Fish'; rankClass = 'rank-fish'; }
    else if (totalEmpNFTs >= 1) { rankName = 'Plankton'; rankClass = 'rank-plankton'; }
    
    // --- DISPLAY RANK & COUNT ---
    walletRankDisplay.innerHTML = ''; // Clear loading
    if (totalEmpNFTs >= 1) {
        // Create Badge
        const badge = document.createElement('span');
        badge.className = `rank-badge ${rankClass}`;
        badge.textContent = rankName;
        
        // Create Count Label
        const countLabel = document.createElement('div');
        countLabel.style.fontSize = '0.5em';
        countLabel.style.marginTop = '8px';
        countLabel.style.fontWeight = '400';
        countLabel.style.opacity = '0.8';
        countLabel.textContent = `${totalEmpNFTs} EMP NFTs`;

        walletRankDisplay.appendChild(badge);
        walletRankDisplay.appendChild(countLabel);
    } else {
        walletRankDisplay.textContent = "No EMP NFTs";
    }

    // --- CATEGORIES ---
    categoryTotalsEl.innerHTML = '';
    
    if (fhodlCount > 0) {
        categoryTotalsEl.innerHTML += `<li><strong>FHODL:</strong> ${fhodlTotalReward} $REWARD from ${fhodlCount} NFT${fhodlCount !== 1 ? 's' : ''}</li>`;
    }

    for (const [cat, info] of Object.entries(empData.categorySums || {})) {
      categoryTotalsEl.innerHTML += `<li><strong>${cat}:</strong> ${info.reward} $REWARD from ${info.count} NFT${info.count !== 1 ? 's' : ''}</li>`;
    }

    const categoriesMap = {};
    if (fhodlCount > 0) {
        categoriesMap["FHODL"] = fhodlNFTs.map(nft => ({
            name: nft.name || nft.identifier,
            reward: fhodlRewardRate,
            attributes: []
        }));
    }

    (empData.includedNFTs || []).forEach(nft => {
      nft.categories.forEach(cat => {
        if (!categoriesMap[cat]) categoriesMap[cat] = [];
        categoriesMap[cat].push(nft);
      });
    });

    categoriesContainer.innerHTML = '';
    for (const [category, nfts] of Object.entries(categoriesMap)) {
      const count = empData.categorySums?.[category]?.count || nfts.length;
      const catDetails = document.createElement('details');
      catDetails.className = "collapsible-cat";
      const catSummary = document.createElement('summary');
      catSummary.innerHTML = `${category} (${count} NFT${count !== 1 ? 's' : ''})`;
      catDetails.appendChild(catSummary);

      const nftList = document.createElement('ul');
      for (const nft of nfts) {
        const nftDetails = document.createElement('details');
        nftDetails.className = "collapsible-nft";
        const nftSummary = document.createElement('summary');
        nftSummary.innerHTML = `${nft.name} (Reward: ${nft.reward})`;
        nftDetails.appendChild(nftSummary);

        const attrList = document.createElement('ul');
        attrList.className = "attr-list";
        if (nft.attributes && nft.attributes.length > 0) {
          nft.attributes.forEach(attr => {
            const li = document.createElement('li');
            li.textContent = `${attr.trait_type}: ${attr.value}`;
            attrList.appendChild(li);
          });
        } else {
          const li = document.createElement('li');
          li.innerHTML = '<em>No attributes found</em>';
          attrList.appendChild(li);
        }
        nftDetails.appendChild(attrList);
        nftList.appendChild(nftDetails);
      }
      catDetails.appendChild(nftList);
      categoriesContainer.appendChild(catDetails);
    }

    if (empData.excludedNFTs.length === 0) {
      excludedList.innerHTML = '<li>All EMP NFTs qualified with traits.</li>';
    } else {
      empData.excludedNFTs.forEach(nft => {
        excludedList.innerHTML += `<li><strong>${nft.name}</strong> No qualifying traits found.</li>`;
      });
    }

  } catch (e) {
    totalRewardEl.textContent = 'Error';
    walletRankDisplay.textContent = 'Error';
    console.error(e);
  }
});

// ... Resync and Load logic remains same ...
document.getElementById('resyncCollectionBtn').addEventListener('click', async () => {
  try {
    const res = await fetch(`/api/all-traits/${empCollectionId}`);
    const categories = await res.json();
    for (const category of categories) {
      if (!rewardsTableBody.querySelector(`input[value="${category}"]`)) {
        await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category, reward: 0 }),
        });
      }
    }
    alert(`Resync complete.`);
    await loadConfig();
  } catch (e) {
    alert('Resync failed: ' + e.message);
  }
});

loadConfig();
loadMintedCount();

async function loadMintedCount() {
  const mintedCountSpan = document.getElementById('mintedCount');
  async function fetchCount() {
    mintedCountSpan.textContent = 'Loading...';
    try {
      const res = await fetch(`https://api.multiversx.com/nfts/count?collection=${empCollectionId}`);
      if (!res.ok) { mintedCountSpan.textContent = 'N/A'; return; }
      const text = await res.text();
      const count = parseInt(text.trim());
      if (!isNaN(count)) mintedCountSpan.textContent = count.toLocaleString();
      else mintedCountSpan.textContent = 'N/A';
    } catch (e) { mintedCountSpan.textContent = 'Error'; }
  }
  await fetchCount();
  setInterval(fetchCount, 30000); 
}
</script>
</body>
</html>
