<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>EMP-897b49 NFT Trait Counts</title>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css"/>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<style>
  body { max-width: 900px; margin: 2em auto; font-family: Arial, sans-serif; }
  label, select { font-size: 1.2em; margin-right: 10px; }
  tfoot tr { font-weight: bold; }
</style>
</head>
<body>
<h1>Trait Counts for EMP-897b49</h1>
<label for="traitType">Show traits containing:</label>
<select id="traitType">
  <option value="">All</option>
  <option value="Head">Head</option>
  <option value="Astronaut">Astronaut</option>
  <option value="Legendary">Legendary</option>
</select>

<table id="traitTable" class="display" style="width:100%">
  <thead>
    <tr><th>Trait Type</th><th>Value</th><th>Count</th><th>Max</th></tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="2" style="text-align:right;">Page Count Total:</td>
      <td id="pageCountTotal"></td>
      <td></td>
    </tr>
    <tr>
      <td colspan="4" style="text-align:right; font-weight:bold;">
        TOTAL NFTs: <span id="totalNFTs"></span>
      </td>
    </tr>
  </tfoot>
</table>
<script>
let dataObj = {};
let dataTableInstance;

async function fillTable(filterTerm) {
  if (dataTableInstance) {
    dataTableInstance.destroy();
    $('#traitTable tbody').empty();
  }

  if (!dataObj.counts) return;

  const counts = dataObj.counts;
  const maxPerTrait = dataObj.maxPerCategory || dataObj.maxPerTrait;
  $('#totalNFTs').text(dataObj.totalNFTs);

  const term = filterTerm.toLowerCase();

  Object.entries(counts).forEach(([traitType, values]) => {
    Object.entries(values).forEach(([value, count]) => {
      if (term) {
        if (term === "astronaut") {
          if (!traitType.toLowerCase().includes("astronaut") && !value.toLowerCase().includes("astronaut")) {
            return;
          }
        } else {
          if (!traitType.toLowerCase().includes(term) && !value.toLowerCase().includes(term)) {
            return;
          }
        }
      }
      const maxVal = maxPerTrait[traitType] || "";
      const row = `<tr>
        <td>${traitType}</td>
        <td>${value}</td>
        <td>${count}</td>
        <td>${maxVal}</td>
      </tr>`;
      $('#traitTable tbody').append(row);
    });
  });

  dataTableInstance = $('#traitTable').DataTable({
    order: [[2, 'desc']],
    paging: true,
    searching: true,
    footerCallback: function(row, data, start, end, display) {
      const api = this.api();
      const intVal = i => typeof i === 'string' ? i.replace(/[\$,]/g, '')*1 : typeof i === 'number' ? i : 0;

      // Sum over this page
      const pageTotal = api
        .column(2, { page: 'current' })
        .data()
        .reduce((a, b) => intVal(a) + intVal(b), 0);

      // Update footer with sum
      $(api.column(2).footer()).html(pageTotal);
    }
  });
}

$(async function() {
  dataObj = await $.getJSON('traits.json');
  fillTable('');
  $('#traitType').on('change', function() {
    fillTable(this.value);
  });
});
</script>
</body>
</html>
